events {}

http {
    server {
        listen 8080;

        root /usr/share/nginx/html;
        index index.html;

        location / {
            try_files $uri $uri/ /index.html;

            # --- HEADER CLEARING ---
            # Remove all default or potentially conflicting headers.
            # Nginx adds several by default that might interfere.
            # Using these empty adds will effectively remove them if present.
            add_header X-Frame-Options "";
            add_header X-Content-Type-Options "";
            add_header X-XSS-Protection "";
            add_header Content-Security-Policy ""; # Clear any previous CSP directives

            # --- EXPLICIT FRAME-ANCESTORS POLICY ---
            # This must be the ONLY frame-ancestors directive.
            # 'self' allows embedding from your Cloud Run domain itself.
            # https://sites.google.com is the standard Google Sites domain.
            # We are removing https://*.google.com for now to be very precise.
            add_header Content-Security-Policy "frame-ancestors 'self' https://sites.google.com;" always;

            # Ensure CORS is permissive if your site needs to make requests
            # back to your Cloud Run service from the embedded iframe,
            # though this is less related to 'refused to connect'.
            # add_header Access-Control-Allow-Origin "https://sites.google.com"; # Only if needed for XHRs from iframe
            # add_header Access-Control-Allow-Methods "GET, POST, OPTIONS"; # Only if needed for XHRs from iframe
            # add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range"; # Only if needed for XHRs from iframe
        }
    }
}
